# TCP协议

报文格式：

1. 源端口(16)：发送端端口

2. 目的端口(16)：目的端口

   > TCP的源端口、目的端口和IP的源IP、目的IP四元组标识了一个TCP连接
   >
   > IP+端口号的组合叫做socket。

3. 序列号(SN, Sequence Number, 32)：当SYN标志位设置时，该字段也称为ISN(initial sequence number)，ISN是由发送端随机产生的。表示了TCP报文中第一个byte在对应方向传输中对应的字节序号。

4. 确认号/应答号(Acknowledgment Number, ACK, 32)：在抓包软件中一般显示相对的Number

   > ## HTTP中的TCP连接
   >
   > ### 建立连接
   >
   > | 客户端                            | 服务端                       |
   > | --------------------------------- | ---------------------------- |
   > | 随机生成ISN，ACK=0                |                              |
   > |                                   | 随机生成SN，ACK为客户端ISN+1 |
   > | 客户端SN为ISN+1，ACK为 服务端SN+1 |                              |
   >
   > ### 数据传输
   >
   > | 客户端      | 服务端                                                       |
   > | ----------- | ------------------------------------------------------------ |
   > | SN，ACK同上 |                                                              |
   > |             | SN=客户端SN，ACK=SN+TCP(?)数据长度（该条是**响应包**）       |
   > |             | 服务器处理请求http后返回响应；SN，ACK同上 [携带数据于上不同] |
   >
   > ![](http://doze9097.top//1573807498451.png)

5. HLEN(头长度，4)：包括TCP头部大小，基本单位为32比特

6. 保留(4)：都为0，用于未来新用途

7. 标志位(8)：8位标志位

   > 1. CWR(Congestion Window Reduce):拥塞窗口减少标志，表明接收到设置**ECE**标志的TCP包，发送端通过降低发送窗口的大小来降低发送速率
   > 2. ECE(ECN Echo)：ECN相应标志被用来TCP3次握手时表明一个TCP端具有ECN功能，并表明接收到的TCP包的IP头部的ECN被设置为 11。
   > 3. URG(Urgent)：用于流量控制和窗口管理
   > 4. ACK(Acknowledgment)：代表ACK Number有效，置1则为TCP确认包，0则不是。
   > 5. PSH(Push)：标识发送端缓存中已经没有待发送的数据，接收端不将改数据进行队列处理，而是尽可能快将数据转由应用处理。在处理telnet或rlogin等交互模式的连接时，该标志总是置位的。
   > 6. RST(Reset)：用于复位响应的TCP连接。通常在发生异常或者错误的时候会触发
   > 7. SYN(Synchronize)：同步序列编号有效。仅在TCP三次握手时有效。提示接收方检查ISN。
   > 8. FIN(Finish)：用于结束TCP绘画。

8. 窗口大小(16位)：用于TCP的流量控制

9. 校验位(16)：根据伪头+tcp头+tcp数据三部分进行计算

10. 紧急指针(16)：指向后面优先传输的字节，在URG标志设置后才有效。若URG没有被设置，紧急域作为填充。

11. 选项(长度不定)：必须为32bits的整数倍。

![img](https://images2015.cnblogs.com/blog/740952/201611/740952-20161107132809311-2059896218.png)

